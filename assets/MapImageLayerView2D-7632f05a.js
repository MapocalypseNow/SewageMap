import{a3 as P,a6 as k,eP as z,dO as D,a8 as n,a9 as p,g6 as Z,ap as W,$ as T,A as K,al as X,aa as F,aK as q,f6 as Y,ao as O,eh as ee,eS as te,g7 as re,O as ie,a4 as se,g8 as ae,g9 as oe,U as ne,fb as le,fR as pe,ai as he,a as ue,r as G,q as ye,ga as me,gb as de,e5 as ce,I as fe,ad as ge,gc as we,E as ve,fz as be,be as xe,ax as $e,aH as A,o as Ie}from"./vendor-445d19db.js";import{a as _e}from"./BitmapContainer-ace96950.js";import{y as Se,u as Ee}from"./LayerView-2f4bfb36.js";import{o as Pe}from"./BaseGraphicContainer-dd7f4c14.js";import{n as Re}from"./HighlightGraphicContainer-25529909.js";import{v as Fe}from"./ExportStrategy-7b9e3f42.js";import{c as je}from"./ExportImageParameters-80ad2fcd.js";import{n as U}from"./floorFilterUtils-080a7cd2.js";import{s as L,a as Ne}from"./drapedUtils-361bbff7.js";import{i as Oe}from"./sublayerUtils-113e7653.js";import{d as Ue,s as Ve}from"./popupUtils-feede9e6.js";import{i as Ge}from"./RefreshableLayerView-10331e5a.js";import"./WGLContainer-7f535211.js";import"./enums-64ab819c.js";import"./pixelUtils-9c524314.js";import"./utils-6396d15b.js";import"./enums-4ca4641f.js";import"./MaterialKey-5504317a.js";import"./Utils-cdacad72.js";import"./enums-8bf08d0c.js";import"./Texture-a2352f23.js";import"./VertexElementDescriptor-2925c6af.js";import"./VertexArrayObject-2a5c5453.js";import"./ProgramTemplate-c51bbb20.js";import"./StyleDefinition-3c6a4c69.js";import"./config-1337d16e.js";import"./GeometryUtils-c093d234.js";import"./earcut-58237617.js";import"./ExpandedCIM-1bd63987.js";import"./BidiEngine-836b7ef6.js";import"./Rect-ea14f53a.js";import"./quantizationUtils-ad21a9c2.js";import"./GeometryUtils-eebff0a0.js";import"./floatRGBA-02bd94bd.js";import"./normalizeUtilsSync-f52aa61a.js";import"./projectionSupport-43081d3f.js";import"./json-48e3ea08.js";import"./FeatureContainer-79c7bb83.js";import"./TileContainer-9841958d.js";import"./visualVariablesUtils-bd2b2199.js";import"./visualVariablesUtils-e0bd40c0.js";import"./Matcher-9357b4ea.js";import"./tileUtils-135b0f25.js";import"./TileClipper-98c28085.js";import"./Geometry-daada628.js";import"./devEnvironmentUtils-5002a058.js";import"./schemaUtils-c8c76855.js";import"./createSymbolSchema-15243994.js";import"./rendererUtils-d69d5f00.js";import"./util-40ea0c97.js";import"./ComputedAttributeStorage-90a9463c.js";import"./FeatureSetReader-350c4cce.js";import"./centroid-3355b51b.js";import"./vec3f32-4322908d.js";import"./Bitmap-3ffc06b2.js";const M=s=>s.spatialReference.wkid||JSON.stringify(s.spatialReference);function Ae(s,e){const{dpi:t,gdbVersion:i,geometry:r,geometryPrecision:a,height:y,layerOption:h,mapExtent:o,maxAllowableOffset:l,returnFieldName:u,returnGeometry:m,returnUnformattedValues:g,returnZ:I,spatialReference:x,timeExtent:$,tolerance:c,width:S}=s.toJSON(),{dynamicLayers:w,layerDefs:f,layerIds:v}=Le(s),V=e&&P(e.geometry)?e.geometry:null,b={geometryPrecision:a,maxAllowableOffset:l,returnFieldName:u,returnGeometry:m,returnUnformattedValues:g,returnZ:I,tolerance:c},E=V&&V.toJSON()||r;if(b.imageDisplay=`${S},${y},${t}`,i&&(b.gdbVersion=i),E&&(delete E.spatialReference,b.geometry=JSON.stringify(E),b.geometryType=k(E)),x?b.sr=x.wkid||JSON.stringify(x):E&&E.spatialReference?b.sr=M(E):o&&o.spatialReference&&(b.sr=M(o)),b.time=$?[$.start,$.end].join(","):null,o){const{xmin:J,ymin:C,xmax:B,ymax:Q}=o;b.mapExtent=`${J},${C},${B},${Q}`}return f&&(b.layerDefs=f),w&&!f&&(b.dynamicLayers=w),b.layers=h==="popup"?"visible":h,v&&!w&&(b.layers+=`:${v.join(",")}`),b}function Le(s){var x,$;const{mapExtent:e,floors:t,width:i,sublayers:r,layerIds:a,layerOption:y,gdbVersion:h}=s,o=($=(x=r==null?void 0:r.find(c=>c.layer!=null))==null?void 0:x.layer)==null?void 0:$.serviceSublayers,l=y==="popup",u={},m=z({extent:e,width:i,spatialReference:e==null?void 0:e.spatialReference}),g=[],I=c=>{const S=m===0,w=c.minScale===0||m<=c.minScale,f=c.maxScale===0||m>=c.maxScale;if(c.visible&&(S||w&&f))if(c.sublayers)c.sublayers.forEach(I);else{if((a==null?void 0:a.includes(c.id))===!1||l&&(!c.popupTemplate||!c.popupEnabled))return;g.unshift(c)}};if(r==null||r.forEach(I),r&&!g.length)u.layerIds=[];else{const c=Oe(g,o,h),S=g.map(w=>{const f=U(t,w);return w.toExportImageJSON(f)});if(c)u.dynamicLayers=JSON.stringify(S);else{if(r){let f=g.map(({id:v})=>v);a&&(f=f.filter(v=>a.includes(v))),u.layerIds=f}else a!=null&&a.length&&(u.layerIds=a);const w=Me(t,g);if(P(w)&&w.length){const f={};for(const v of w)v.definitionExpression&&(f[v.id]=v.definitionExpression);Object.keys(f).length&&(u.layerDefs=JSON.stringify(f))}}}return u}function Me(s,e){const t=!!(s!=null&&s.length),i=e.filter(r=>r.definitionExpression!=null||t&&r.floorInfo!=null);return i.length?i.map(r=>{const a=U(s,r),y=D(a,r.definitionExpression);return{id:r.id,definitionExpression:y}}):null}var N;let d=N=class extends q{constructor(s){super(s),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}static from(s){return Y(N,s)}};n([p({type:Number,json:{write:!0}})],d.prototype,"dpi",void 0),n([p()],d.prototype,"floors",void 0),n([p({type:String,json:{write:!0}})],d.prototype,"gdbVersion",void 0),n([p({types:Z,json:{read:W,write:!0}})],d.prototype,"geometry",void 0),n([p({type:Number,json:{write:!0}})],d.prototype,"geometryPrecision",void 0),n([p({type:Number,json:{write:!0}})],d.prototype,"height",void 0),n([p({type:[Number],json:{write:!0}})],d.prototype,"layerIds",void 0),n([p({type:["top","visible","all","popup"],json:{write:!0}})],d.prototype,"layerOption",void 0),n([p({type:T,json:{write:!0}})],d.prototype,"mapExtent",void 0),n([p({type:Number,json:{write:!0}})],d.prototype,"maxAllowableOffset",void 0),n([p({type:Boolean,json:{write:!0}})],d.prototype,"returnFieldName",void 0),n([p({type:Boolean,json:{write:!0}})],d.prototype,"returnGeometry",void 0),n([p({type:Boolean,json:{write:!0}})],d.prototype,"returnM",void 0),n([p({type:Boolean,json:{write:!0}})],d.prototype,"returnUnformattedValues",void 0),n([p({type:Boolean,json:{write:!0}})],d.prototype,"returnZ",void 0),n([p({type:K,json:{write:!0}})],d.prototype,"spatialReference",void 0),n([p()],d.prototype,"sublayers",void 0),n([p({type:X,json:{write:!0}})],d.prototype,"timeExtent",void 0),n([p({type:Number,json:{write:!0}})],d.prototype,"tolerance",void 0),n([p({type:Number,json:{write:!0}})],d.prototype,"width",void 0),d=N=n([F("esri.rest.support.IdentifyParameters")],d);const H=d;let _=class extends q{constructor(e){super(e),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(e,t){return O.fromJSON({attributes:{...t.attributes},geometry:{...t.geometry}})}writeFeature(e,t){if(!e)return;const{attributes:i,geometry:r}=e;i&&(t.attributes={...i}),P(r)&&(t.geometry=r.toJSON(),t.geometryType=re.toJSON(r.type))}};n([p({type:String,json:{write:!0}})],_.prototype,"displayFieldName",void 0),n([p({type:O})],_.prototype,"feature",void 0),n([ee("feature",["attributes","geometry"])],_.prototype,"readFeature",null),n([te("feature")],_.prototype,"writeFeature",null),n([p({type:Number,json:{write:!0}})],_.prototype,"layerId",void 0),n([p({type:String,json:{write:!0}})],_.prototype,"layerName",void 0),_=n([F("esri.rest.support.IdentifyResult")],_);const Te=_;async function qe(s,e,t){const i=(e=Je(e)).geometry?[e.geometry]:[],r=ie(s);return r.path+="/identify",se(i).then(a=>{const y=Ae(e,{geometry:a&&a[0]}),h=ae({...r.query,f:"json",...y}),o=oe(h,t);return ne(r.path,o).then(He).then(l=>Ce(l,e.sublayers))})}function He(s){const e=s.data;return e.results=e.results||[],e.exceededTransferLimit=Boolean(e.exceededTransferLimit),e.results=e.results.map(t=>Te.fromJSON(t)),e}function Je(s){return s=H.from(s)}function Ce(s,e){if(!(e!=null&&e.length))return s;const t=new Map;function i(r){t.set(r.id,r),r.sublayers&&r.sublayers.forEach(i)}e.forEach(i);for(const r of s.results)r.feature.sourceLayer=t.get(r.layerId);return s}let j=null;const Be=s=>{let e=class extends s{constructor(){super(...arguments),this._featuresResolutions=new WeakMap,this.highlightGraphics=new pe,this.updateHighlightedFeatures=he(async t=>{this.destroyed||this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(t).catch(()=>{}))})}initialize(){this.exportImageParameters=new je({layer:this.layer}),this.handles.add([ue(()=>this.highlightGraphics,"change",t=>{this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(t.added).catch(()=>{})),this.updateHighlightedFeatures(this._highlightGeometriesResolution)})])}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var t;return(t=this.exportImageParameters)==null||t.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}async fetchPopupFeatures(t,i){var y,h,o,l;const{layer:r}=this;if(!t)throw new G("mapimagelayer:fetchPopupFeatures","Nothing to fetch without area",{layer:r});const a=((h=(y=this.layer.capabilities)==null?void 0:y.operations)==null?void 0:h.supportsQuery)??!0;if(!((((l=(o=this.layer.capabilities)==null?void 0:o.operations)==null?void 0:l.supportsIdentify)??!0)&&this.layer.version>=10.5)&&!a)throw new G("mapimagelayer:fetchPopupFeatures-not-supported","query operation is disabled for this service",{layer:r});return a?this._fetchPopupFeaturesUsingQueries(t,i):this._fetchPopupFeaturesUsingIdentify(t,i)}canResume(){var t;return!!super.canResume()&&!((t=this.timeExtent)!=null&&t.isEmpty)}async _updateHighlightedFeaturesSymbols(t){for(const i of t){const r="renderer"in i.sourceLayer&&i.sourceLayer.renderer;"geometryType"in i.sourceLayer&&i.sourceLayer.geometryType==="point"&&r&&"getSymbolAsync"in r&&r.getSymbolAsync(i).then(async a=>{var o;let y="width"in a&&"height"in a&&a.width!=null&&a.height!=null?Math.max(a.width,a.height):"size"in a?a.size:null;const h="visualVariables"in r&&((o=r.visualVariables)==null?void 0:o.find(l=>l.type==="size"));h&&(j||(j=(await ye(()=>import("./vendor-445d19db.js").then(l=>l.lL),[])).getSize),y=j(h,i,{view:this.view.type,scale:this.view.scale,shape:a.type==="simple-marker"?a.style:null})),this.highlightGraphics.includes(i)&&(i.symbol=new me({style:"square",size:y,xoffset:"xoffset"in a?a.xoffset:0,yoffset:"yoffset"in a?a.yoffset:0}),i.visible=!0,this.highlightGraphicUpdated(i,"symbol"))})}}async _updateHighlightedFeaturesGeometries(t){this._highlightGeometriesResolution=t;const i=this.highlightGraphics;if(!i.length||!this.layer.capabilities.operations.supportsQuery)return;const r=this._getTargetResolution(t),a=new Map;for(const o of i)if(!this._featuresResolutions.has(o)||this._featuresResolutions.get(o)>r){const l=o.sourceLayer;de(a,l,()=>new Map).set(o.getObjectId(),o)}const y=Array.from(a,([o,l])=>{const u=o.createQuery();return u.objectIds=[...l.keys()],u.outFields=[o.objectIdField],u.returnGeometry=!0,u.maxAllowableOffset=r,u.outSpatialReference=this.view.spatialReference,o.queryFeatures(u)}),h=await Promise.all(y);if(!this.destroyed)for(const{features:o}of h)for(const l of o){const u=l.sourceLayer,m=a.get(u).get(l.getObjectId());m&&this.highlightGraphics.includes(m)&&(m.geometry=l.geometry,this.highlightGraphicUpdated(m,"geometry"),this._featuresResolutions.set(m,r))}}_getTargetResolution(t){const i=t*ce(this.view.spatialReference),r=i/16;return r<=10?0:t/i*r}async _fetchPopupFeaturesUsingIdentify(t,i){const r=await this._createIdentifyParameters(t,i);if(fe(r))return[];const{results:a}=await qe(this.layer.parsedUrl,r);return a.map(y=>y.feature)}async _createIdentifyParameters(t,i){const{floors:r,spatialReference:a,scale:y}=this.view,h=P(i)?i.event:null,o=await this._collectPopupProviders(this.layer.sublayers,y,i);if(!o.length)return null;await Promise.all(o.map(({sublayer:x})=>x.load().catch(()=>{})));const l=Math.min(ge("mapimagelayer-popup-identify-max-tolerance"),this.layer.allSublayers.reduce((x,$)=>$.renderer?L({renderer:$.renderer,event:h}):x,2)),u=this.createFetchPopupFeaturesQueryGeometry(t,l),m=we(y,a),g=Math.round(u.width/m),I=new T({xmin:u.center.x-m*g,ymin:u.center.y-m*g,xmax:u.center.x+m*g,ymax:u.center.y+m*g,spatialReference:u.spatialReference});return new H({floors:r,gdbVersion:this.layer.gdbVersion,geometry:t,height:g,layerOption:"popup",mapExtent:I,returnGeometry:!0,spatialReference:a,sublayers:this.layer.sublayers,timeExtent:this.timeExtent,tolerance:l,width:g})}async _fetchPopupFeaturesUsingQueries(t,i){const r=await this._collectPopupProviders(this.layer.sublayers,this.view.scale,i),a=P(i)?i.event:null,y=r.map(async({sublayer:h,popupTemplate:o})=>{var S,w;await h.load().catch(()=>{});const l=h.createQuery(),u=L({renderer:h.renderer,event:a}),m=this.createFetchPopupFeaturesQueryGeometry(t,u);if(l.geometry=m,l.outFields=await Ue(h,o),l.timeExtent=this.timeExtent,"floors"in this.view){const f=(w=(S=this.view)==null?void 0:S.floors)==null?void 0:w.clone(),v=U(f,h);P(v)&&(l.where=l.where?`(${l.where}) AND (${v})`:v)}const g=this._getTargetResolution(m.width/u),I=await this._loadArcadeModules(o),x=h.geometryType==="point"||I&&I.arcadeUtils.hasGeometryOperations(o);x||(l.maxAllowableOffset=g);const{features:$}=await h.queryFeatures(l),c=x?0:g;for(const f of $)this._featuresResolutions.set(f,c);return $});return(await ve(y)).reverse().reduce((h,o)=>o.value?[...h,...o.value]:h,[]).filter(h=>h!=null)}async _collectPopupProviders(t,i,r){const a=[],y=async o=>{const l=o.minScale===0||i<=o.minScale,u=o.maxScale===0||i>=o.maxScale;if(o.visible&&l&&u){if(o.sublayers)o.sublayers.forEach(y);else if(o.popupEnabled){const m=Ve(o,{...r,defaultPopupTemplateEnabled:!1});P(m)&&a.unshift({sublayer:o,popupTemplate:m})}}},h=t.toArray().reverse().map(y);return await Promise.all(h),a}_loadArcadeModules(t){var i;if((i=t.expressionInfos)!=null&&i.length||Array.isArray(t.content)&&t.content.some(r=>r.type==="expression"))return be()}};return n([p()],e.prototype,"highlightGraphics",void 0),n([p()],e.prototype,"exportImageParameters",void 0),n([p({readOnly:!0})],e.prototype,"exportImageVersion",null),n([p()],e.prototype,"layer",void 0),n([p()],e.prototype,"suspended",void 0),n([p(le)],e.prototype,"timeExtent",void 0),e=n([F("esri.views.layers.MapImageLayerView")],e),e};let R=class extends Be(Ge(Se(Ee))){update(s){this.strategy.update(s).catch(e=>{xe(e)||$e.getLogger(this.declaredClass).error(e)}),s.stationary&&this.updateHighlightedFeatures(s.state.resolution),this._highlightView.processUpdate(s)}attach(){const{imageMaxWidth:s,imageMaxHeight:e,version:t}=this.layer,i=t>=10.3,r=t>=10;this._bitmapContainer=new _e,this.container.addChild(this._bitmapContainer),this._highlightView=new Pe({view:this.view,graphics:this.highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new Re(this.view.featuresTilingScheme)}),this.container.addChild(this._highlightView.container),this.strategy=new Fe({container:this._bitmapContainer,fetchSource:this.fetchImageBitmap.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:s,imageMaxHeight:e,imageRotationSupported:i,imageNormalizationSupported:r,hidpi:!0}),this.handles.add(A(()=>this.exportImageVersion,()=>this.requestUpdate()),"exportImageVersion"),this.handles.add(A(()=>{var a;return(a=this.view)==null?void 0:a.floors},()=>this.requestUpdate()),"view.floors"),this.requestUpdate()}detach(){this.handles.remove("exportImageVersion"),this.handles.remove("view.floors"),this.strategy.destroy(),this.container.removeAllChildren(),this._bitmapContainer.removeAllChildren(),this._highlightView.destroy()}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}highlight(s){let e=null;if(s instanceof O?e=[s]:Ie.isCollection(s)&&s.length>0?e=s.toArray():Array.isArray(s)&&s.length>0&&(e=s),e=e==null?void 0:e.filter(Boolean),!e||!e.length)return{remove:()=>{}};for(const t of e)"geometryType"in t.sourceLayer&&t.sourceLayer.geometryType==="point"&&(t.visible=!1);return this.highlightGraphics.addMany(e),{remove:()=>{this.highlightGraphics.removeMany(e)}}}supportsSpatialReference(s){return this.layer.serviceSupportsSpatialReference(s)}createFetchPopupFeaturesQueryGeometry(s,e){return Ne(s,e,this.view)}async doRefresh(){this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}highlightGraphicUpdated(s,e){this._highlightView.graphicUpdateHandler({graphic:s,property:e})}fetchImage(s,e,t,i){return this.layer.fetchImage(s,e,t,{timeExtent:this.timeExtent,floors:this.view.floors,...i})}fetchImageBitmap(s,e,t,i){return this.layer.fetchImageBitmap(s,e,t,{timeExtent:this.timeExtent,floors:this.view.floors,...i})}};n([p()],R.prototype,"strategy",void 0),n([p()],R.prototype,"updating",void 0),R=n([F("esri.views.2d.layers.MapImageLayerView2D")],R);const zt=R;export{zt as default};
