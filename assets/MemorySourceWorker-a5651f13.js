import{s as I,hR as M,g9 as v,d6 as Q,ga as Z,fI as $,hS as A,Q as k,b2 as b,M as _,cZ as q,c$ as C,hT as P,gc as D,br as O}from"./vendor-8855e047.js";import{t as G,n as z}from"./objectIdUtils-789e911a.js";import{u as L}from"./FeatureStore-8f4d7011.js";import{f as E,g as T}from"./projectionSupport-e3191e9a.js";import{Y as W}from"./QueryEngine-cfed60ec.js";import{w as B,a as g,m as j,f as x,g as w}from"./sourceUtils-5bf6bf20.js";import"./PooledRBush-72be9550.js";import"./centroid-19b48edf.js";import"./json-48e3ea08.js";import"./QueryEngineResult-fed0cf5d.js";import"./WhereClause-b5dbe378.js";import"./utils-22c67127.js";import"./timeSupport-712a52a0.js";const U=D,H={xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:D},V={hasAttachments:!1,capabilities:"query, editing, create, delete, update",useStandardizedQueries:!0,supportsCoordinatesQuantization:!0,supportsReturningQueryGeometry:!0,advancedQueryCapabilities:{supportsQueryAttachments:!1,supportsStatistics:!0,supportsPercentileStatistics:!0,supportsReturningGeometryCentroid:!0,supportsQueryWithDistance:!0,supportsDistinct:!0,supportsReturningQueryExtent:!0,supportsReturningGeometryProperties:!1,supportsHavingClause:!0,supportsOrderBy:!0,supportsPagination:!0,supportsQueryWithResultType:!1,supportsSqlExpression:!0,supportsDisjointSpatialRel:!0}};function X(m){return O(m)?m.z!=null:!!m.hasZ}function Y(m){return O(m)?m.m!=null:!!m.hasM}class de{constructor(){this._queryEngine=null,this._nextObjectId=null}destroy(){this._queryEngine&&this._queryEngine&&this._queryEngine.destroy(),this._queryEngine=this._fieldsIndex=this._createDefaultAttributes=null}async load(e){const t=[],{features:a}=e,i=this._inferLayerProperties(a,e.fields),o=e.fields||[],p=e.hasM!=null?e.hasM:i.hasM,y=e.hasZ!=null?e.hasZ:i.hasZ,f=!e.spatialReference&&!i.spatialReference,u=f?U:e.spatialReference||i.spatialReference,l=f?H:null,s=e.geometryType||i.geometryType,c=!s;let d=e.objectIdField||i.objectIdField,r=e.timeInfo;if(!c&&(f&&t.push({name:"feature-layer:spatial-reference-not-found",message:"Spatial reference not provided or found in features. Defaults to WGS84"}),!s))throw new I("feature-layer:missing-property","geometryType not set and couldn't be inferred from the provided features");if(!d)throw new I("feature-layer:missing-property","objectIdField not set and couldn't be found in the provided fields");if(i.objectIdField&&d!==i.objectIdField&&(t.push({name:"feature-layer:duplicated-oid-field",message:`Provided objectIdField "${d}" doesn't match the field name "${i.objectIdField}", found in the provided fields`}),d=i.objectIdField),d&&!i.objectIdField){let n=null;o.some(h=>h.name===d&&(n=h,!0))?(n.type="esriFieldTypeOID",n.editable=!1,n.nullable=!1):o.unshift({alias:d,name:d,type:"esriFieldTypeOID",editable:!1,nullable:!1})}for(const n of o){if(n.name==null&&(n.name=n.alias),n.alias==null&&(n.alias=n.name),!n.name)throw new I("feature-layer:invalid-field-name","field name is missing",{field:n});if(n.name===d&&(n.type="esriFieldTypeOID"),!M.jsonValues.includes(n.type))throw new I("feature-layer:invalid-field-type",`invalid type for field "${n.name}"`,{field:n})}const F={};for(const n of o)if(n.type!=="esriFieldTypeOID"&&n.type!=="esriFieldTypeGlobalID"){const h=v(n);h!==void 0&&(F[n.name]=h)}if(this._fieldsIndex=new Q(o),this._createDefaultAttributes=Z(F,d),r){if(r.startTimeField){const n=this._fieldsIndex.get(r.startTimeField);n?(r.startTimeField=n.name,n.type="esriFieldTypeDate"):r.startTimeField=null}if(r.endTimeField){const n=this._fieldsIndex.get(r.endTimeField);n?(r.endTimeField=n.name,n.type="esriFieldTypeDate"):r.endTimeField=null}if(r.trackIdField){const n=this._fieldsIndex.get(r.trackIdField);n?r.trackIdField=n.name:(r.trackIdField=null,t.push({name:"feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:r}}))}r.startTimeField||r.endTimeField||(t.push({name:"feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing or invalid",details:{timeInfo:r}}),r=null)}const R={warnings:t,featureErrors:[],layerDefinition:{...V,drawingInfo:$(s),templates:A(F),extent:l,geometryType:s,objectIdField:d,fields:o,hasZ:!!y,hasM:!!p,timeInfo:r},assignedObjectIds:{}};if(this._queryEngine=new W({fields:o,geometryType:s,hasM:p,hasZ:y,objectIdField:d,spatialReference:u,featureStore:new L({geometryType:s,hasM:p,hasZ:y}),timeInfo:r,cacheSpatialQueries:!0}),!a||!a.length)return this._nextObjectId=G,R;const S=z(d,a);return this._nextObjectId=S+1,await E(a,u),this._loadInitialFeatures(R,a)}async applyEdits(e){const{spatialReference:t,geometryType:a}=this._queryEngine;return await Promise.all([B(t,a),E(e.adds,t),E(e.updates,t)]),this._applyEdits(e)}queryFeatures(e,t={}){return this._queryEngine.executeQuery(e,t.signal)}queryFeatureCount(e,t={}){return this._queryEngine.executeQueryForCount(e,t.signal)}queryObjectIds(e,t={}){return this._queryEngine.executeQueryForIds(e,t.signal)}queryExtent(e,t={}){return this._queryEngine.executeQueryForExtent(e,t.signal)}querySnapping(e,t={}){return this._queryEngine.executeQueryForSnapping(e,t.signal)}_inferLayerProperties(e,t){let a,i,o=null,p=null,y=null;for(const f of e){const u=f.geometry;if(!k(u)&&(o||(o=b(u)),p||(p=u.spatialReference),a==null&&(a=X(u)),i==null&&(i=Y(u)),o&&p&&a!=null&&i!=null))break}if(t&&t.length){let f=null;t.some(u=>{const l=u.type==="esriFieldTypeOID",s=!u.type&&u.name&&u.name.toLowerCase()==="objectid";return f=u,l||s})&&(y=f.name)}return{geometryType:o,spatialReference:p,objectIdField:y,hasM:i,hasZ:a}}_loadInitialFeatures(e,t){const{geometryType:a,hasM:i,hasZ:o,objectIdField:p,spatialReference:y,featureStore:f}=this._queryEngine,u=[];for(const l of t){if(l.uid!=null&&(e.assignedObjectIds[l.uid]=-1),l.geometry&&a!==b(l.geometry)){e.featureErrors.push(g("Incorrect geometry type."));continue}const s=this._createDefaultAttributes(),c=j(this._fieldsIndex,s,l.attributes,!0,e.warnings);c?e.featureErrors.push(c):(this._assignObjectId(s,l.attributes,!0),l.attributes=s,l.uid!=null&&(e.assignedObjectIds[l.uid]=l.attributes[p]),_(l.geometry)&&(l.geometry=T(l.geometry,l.geometry.spatialReference,y)),u.push(l))}if(f.addMany(q([],u,a,o,i,p)),e.layerDefinition.extent=this._queryEngine.fullExtent,e.layerDefinition.timeInfo){const{start:l,end:s}=this._queryEngine.timeExtent;e.layerDefinition.timeInfo.timeExtent=[l,s]}return e}_applyEdits(e){const{adds:t,updates:a,deletes:i}=e,o={addResults:[],deleteResults:[],updateResults:[],uidToObjectId:{}};if(t&&t.length&&this._applyAddEdits(o,t),a&&a.length&&this._applyUpdateEdits(o,a),i&&i.length){for(const p of i)o.deleteResults.push(x(p));this._queryEngine.featureStore.removeManyById(i)}return{fullExtent:this._queryEngine.fullExtent,featureEditResults:o}}_applyAddEdits(e,t){const{addResults:a}=e,{geometryType:i,hasM:o,hasZ:p,objectIdField:y,spatialReference:f,featureStore:u}=this._queryEngine,l=[];for(const s of t){if(s.geometry&&i!==b(s.geometry)){a.push(g("Incorrect geometry type."));continue}const c=this._createDefaultAttributes(),d=j(this._fieldsIndex,c,s.attributes);if(d)a.push(d);else{if(this._assignObjectId(c,s.attributes),s.attributes=c,s.uid!=null){const r=s.attributes[y];e.uidToObjectId[s.uid]=r}if(_(s.geometry)){const r=s.geometry.spatialReference??f;s.geometry=T(w(s.geometry,r),r,f)}l.push(s),a.push(x(s.attributes[y]))}}u.addMany(q([],l,i,p,o,y))}_applyUpdateEdits({updateResults:e},t){const{geometryType:a,hasM:i,hasZ:o,objectIdField:p,spatialReference:y,featureStore:f}=this._queryEngine;for(const u of t){const{attributes:l,geometry:s}=u,c=l&&l[p];if(c==null){e.push(g(`Identifier field ${p} missing`));continue}if(!f.has(c)){e.push(g(`Feature with object id ${c} missing`));continue}const d=C(f.getFeature(c),a,o,i);if(_(s)){if(a!==b(s)){e.push(g("Incorrect geometry type."));continue}const r=s.spatialReference??y;d.geometry=T(w(s,r),r,y)}if(l){const r=j(this._fieldsIndex,d.attributes,l);if(r){e.push(r);continue}}f.add(P(d,a,o,i,p)),e.push(x(c))}}_assignObjectId(e,t,a=!1){const i=this._queryEngine.objectIdField;a&&t&&isFinite(t[i])?e[i]=t[i]:e[i]=this._nextObjectId++}}export{de as default};
